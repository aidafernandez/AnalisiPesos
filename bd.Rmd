---
title: "BD"
author: "Aida Fernandez, 1497182"
fontsize: 11pt
documentclass: article
output:
  html_document:
    df_print: paged
    number_sections: false
  pdf_document: 
    keep_tex: true
---

## Tractament de les dades
Llegim les dades.
```{r}
library(readxl)
#pesInd <- read_excel("G://GEA4//PRACTIQUES//pesosIndividuales.xlsx",                      range = "A1:D949")
pesInd <- read_excel("E://GEA4//PRACTIQUES//pesosIndividuales.xlsx",                      range = "A1:D949")
```

Comprovem que les dades s'han llegit com voliem.
```{r}
View(pesInd)
names(pesInd)
dim(pesInd)
```

????Posem les variables "Box" i "Treat" com a factors.????
```{r}
pesInd$Box <- as.factor(pesInd$Box)
pesInd$Treat <- as.factor(pesInd$Treat)

levels(pesInd$Box)
levels(pesInd$Treat)
```


### Tractament de les dades faltants

Observem que hi ha dades faltants només en el pes al dia 41.
```{r}
apply(pesInd,2,anyNA)
```

Observem com es distribueixen les dades faltants segons el Tractament.
```{r}
naTreat <- aggregate(as.data.frame(is.na(pesInd))$BW41, by=list(pesInd$Treat), FUN=sum)
colnames(naTreat) <- c("Treat","NombreDeNA")
naTreat
```

Observem com es distribueixen les dades faltants segons la Caixa.
```{r}
naBox <- aggregate(as.data.frame(is.na(pesInd))$BW41, by=list(pesInd$Box), FUN=sum)
colnames(naBox) <- c("Box","NombreDeNA")
```

Mostrem només aquells que contenen dades faltants.
```{r}
subset(naBox,naBox$NombreDeNA > 0)
```

*** Test per a veure si la distribució de les dades faltants es pot considerar aleatòria?


#### Eliminació de les dades faltants
Si concluim en que la distribució de les dades faltants es pot considerar aleatòria i que n'hi ha poques podem omitir aquestes dades i treure-les de la base de dades sabent que no esbiaixaràn l'anàlisi. Encara que cal tenir en compte que hi haurà una petita pèrdua d'informació.

```{r}
pesIndOmitNA <- na.omit(pesInd)
```


#### Substitució per la mitjana o mediana:

Una altra opció seria substituir les dades faltants per la mediana o la mitjana de les dades totals, o bé, del grup corresponent. Hi ha un inconvenient, ja que tot i que la mitjana de les dades o els grups no canviaria, disminuiria la variància.


#### Estimació del valor de les dades faltants mitjançant un model lineal múltiple

Serà possible explicar la incertesa.

##### Manera "rudimentaria"
Obviem la variable Box per tal de simplificar el model lineal.
```{r}
lmMod <- lm(BW41 ~ Treat + BW28, data = pesInd)
summary(lmMod)
casosNA <- pesInd[!complete.cases(pesInd$BW41),]
```

*** $R^2$ Molt dolent!!!

Creem un duplicat de la base de dades original per a no modificarla.
```{r}
pesIndEstNA <- pesInd
```

Substituim les prediccions del model per les corresponents dades faltants a la base de dades.
```{r}
predCasosNA <- predict.lm(lmMod,casosNA[,c("Treat","BW28")])
pesIndEstNA[!complete.cases(pesInd$BW41),]$BW41 <- predCasosNA
```


##### Package "mice"

```{r}
# install.packages("mice")
library(mice)
```

Es basa en el Multivariate Imputation by Chained Equations, es a dir, Imputació multivariant per equacions encadenades.

La funció _mice()_ crea múltiples imputacions per les dades faltants multivariants. El mètode imputa cada variable incompleta segons un model separat

Primer provem amb el mètode predeterminat, que és el "Predictive Mean Matching" 
```{r}
MicePmm <- mice(pesInd)
summary(MicePmm)
```

A continuació completem les dades amb _complete()_:
```{r}
pesIndMicePmm <- complete(MicePmm)
```

Observem tots el mètodes d'imputació de la funció _mice()_.
```{r}
methods(mice)
```

## Histogrames comparatius
Amb les següents llibraries podrem obtenir ggplots d'una manera considerablement senzilla.
```{r}
library(ggplot2)
# install.packages("devtools")
library(devtools)
# devtools::install_github("kassambara/easyGgplot2")
library(easyGgplot2)
```

*** He intuit que el pes que es vol comparar és el de les 41 setmanes.

Funció per a simplificar l'obtenció dels histogrames per a comparar tractaments.
Els arguments de la funció són:

  * "BD" la base de dades.
  
  * "Trac1" i "Tract2" són els tractaments a comparar.
  
  * "TipusGraf" si és 1 representem els histogrames solapant-se al mateix eix de les y,
               si val 2 representarem els histogrames un a sobre de l'altre pero en diferents eix y.
               
  * "NombreBins" és el nombre de "caixes" en que estarà dividit l'histograma de cadascún dels tractaments, el valor predeterminat és 10.
 
```{r}
histComparatius <- function(BD, Tract1, Tract2,TipusGraf=c(1,2),NombreBins=10,col=4){
  t1vst2 <- subset(BD,Treat == c(Tract1,Tract2))
  
  if(TipusGraf==1){
  ggplot2.histogram(data=t1vst2, xName=colnames(BD)[col],
    groupName='Treat', legendPosition="top",
    alpha=0.5, addDensity=TRUE, xlim = c(100,4000), bins=NombreBins*2,
    addMeanLine=TRUE, meanLineColor="white", meanLineSize=1.5)
  }

  else{
  ggplot2.histogram(data=t1vst2, xName='BW41',
         groupName='Treat', legendPosition="top", xlim = c(100,4000), bins=NombreBins*2,
        faceting=TRUE, facetingVarNames="Treat")
  }
}

histComparatius(pesInd,1,8,1,20)
histComparatius(pesInd,1,8,2,20)
```


Fem els histogrames de tipus 2 de tots els tractaments enfront el tractament de control:

```{r}
histComparatius(pesInd,1,2,2)
histComparatius(pesInd,1,3,2)
histComparatius(pesInd,1,4,2)
histComparatius(pesInd,1,5,2)
histComparatius(pesInd,1,6,2)
histComparatius(pesInd,1,7,2)
histComparatius(pesInd,1,8,2)
```


## Funcions del paquet _snpar_
```{r}
# install.packages("snpar")
library(snpar)
help("snpar")
library(help = snpar)
```

Observem que segons la _R Documentation_ del package, aquest ens proporciona Mètodes Estadístics Suplementaris No-Paramètrics. 

https://cran.r-project.org/web/packages/snpar/snpar.pdf

  * Cox-Stuart Trend Test - **cs.test** - Test per a detectar la presència de tendència sense importar la distribució de les dades.
 
  * Kernel Density and Distribution Estimation - **kde** - Computa una estimació no-paramètrica del nucli de la PDF i la CDF.

  * Kernel Regression Estimation - **kre** - Ajusta una relació no paramètrica entre un parell de variables aleatòries mitjançant el mètode del nucli.
  
  * Kolmogorov-Smirnov Test - **ks.test** - És una prova no paramètrica que determina la bondat d'ajust de dues distribucions de probabilitat entre si.
  
  * Normal Score (Van der Waerden) Test - **ns.test** - Test no paramètric per a testar la hipòtesi que _k_ funcions de distribució mostrals són iguals.
  
  * Quantile Test - **quant.test** - Realitza una prova de quantils d'una mostra i d'igualtat de quantils de dues mostres.
  
  * Runs Test for Randomness - **runs.test** - Realitza un test per a l'aleatorietat d'una seqüència numèrica.




```{r}
plot(pesInd$BW28, pesInd$BW41)
```

Calcular l'error típic de la predicció que depèn de cada dada faltant i generar una normal centrada en el punt de la recta i amb desviació l'error típic.
